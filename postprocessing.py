import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from typing import Union

def create_criteres(bdd_metal:dict) -> dict:
    """
    Create a dictionary of mechanical criteria from the properties of multiple metals.
    
    - `Min Yield strength`: smallest yield strength between the two metals.
    - `Min Ultimate tensile strength`: smallest ultimate tensile strength between the two metals.
    - `Min Elongation`: smallest elongation between the two metals.
    - `Max Reduction of area`: largest reduction of area between the two metals.

    Parameters
    ----------
    bdd_metal : dict
        Dictionary containing the mechanical properties of each metal.
        Each key corresponds to a metal name, and each value is a dictionary
        containing at least the following fields:
        - "Yield strength"
        - "Ultimate tensile strength"
        - "Elongation"
        - "Reduction of area"

    Returns
    -------
    couple_metal
        A dictionary where the keys are strings of the form `"Metal1 + Metal2"`
        and the values are dictionaries containing the computed mechanical criteria.
    """
    couple_metal = {}
    metals = list(bdd_metal.keys())
    for i in range(len(metals)):
        metal1 = metals[i]

        for j in range(i, len(metals)):
            metal2 = metals[j]

            couple_metal[metal1 + " + " + metal2] = {
                    "Min Yield strength" : min(bdd_metal[metal1]["Yield strength"], bdd_metal[metal2]["Yield strength"]),
                    "Min Ultimate tensile strength" : min(bdd_metal[metal1]["Ultimate tensile strength"], bdd_metal[metal2]["Ultimate tensile strength"]),
                    "Min Elongation" : min(bdd_metal[metal1]["Elongation"], bdd_metal[metal2]["Elongation"]),
                    "Max Reduction of area" : max(bdd_metal[metal1]["Reduction of area"], bdd_metal[metal2]["Reduction of area"])
                }
            
    return couple_metal

def check_conditions(row:pd.Series, couple_metal:dict, couple:str) -> Union[str, tuple[str, ...]]:
    """
    Evaluate whether a material meets the mechanical criteria for a given metal pair.

    Parameters
    ----------
    row : pd.Series
        Row containing the mechanical properties of the tested material.
        Must include the following fields:
        - "Yield strength"
        - "Ultimate tensile strength"
        - "Elongation"
        - "Reduction of area"
    couple_metal : dict
        Dictionary containing the computed mechanical criteria for all metal pairs.
        Typically generated by the `create_criteres` function.
    couple : str
        Key identifying the metal pair to compare against (e.g., "NF616 + P91").

    Returns
    -------
    result : str or tuple of str
        Returns "Good" if all conditions are met, otherwise a tuple listing
        the property names that failed the criteria check.
    """
    failed = []

    if not (row["Yield strength"] >= couple_metal[couple]["Min Yield strength"]):
        failed.append("Yield strength")

    if not (row["Ultimate tensile strength"] >= couple_metal[couple]["Min Ultimate tensile strength"]):
        failed.append("Ultimate tensile strength")

    if not (row["Elongation"] >= couple_metal[couple]["Min Elongation"]):
        failed.append("Elongation")

    if not (row["Reduction of area"] <= couple_metal[couple]["Max Reduction of area"]):
        failed.append("Reduction of area")

    return "Good" if not failed else tuple(failed)

def classif_weld(bdd_metal:dict, bdd_weld:pd.DataFrame, format:str) -> pd.DataFrame:
    """
    Classifies welds based on mechanical property comparisons with reference metals.

    This function evaluates the compatibility between the measured mechanical properties of 
    a set of welds (`bdd_weld`) and the reference criteria defined from a database of metals 
    (`bdd_metal`). Three output formats are supported:

    - ``"score"``: returns an average normalized score (0–1) based on four criteria:
      * Yield strength  
      * Ultimate tensile strength  
      * Elongation  
      * Reduction of area  
      The score equals 1 when the weld meets or exceeds all required thresholds.

    - ``"detail"``: returns a detailed result for each weld and each 
      reference metal, using the `check_conditions` function to verify criteria individually.

    - ``"binary"``: returns a boolean table indicating whether each weld satisfies all 
      threshold conditions simultaneously.

    Parameters
    ----------
    bdd_metal : dict
        Database containing the minimum and maximum mechanical property thresholds for 
        different reference metals.  
        Must include the following columns:  
        ``["Min Yield strength", "Min Ultimate tensile strength", "Min Elongation", "Max Reduction of area"]``.

    bdd_weld : pandas.DataFrame
        Database containing the measured mechanical properties of welds to classify.  
        Must include the following columns:  
        ``["Yield strength", "Ultimate tensile strength", "Elongation", "Reduction of area"]``.

    format : str
        Specifies the output format. Must be one of:
        - ``"score"`` : returns normalized mean scores (float values between 0 and 1)
        - ``"detail"`` : returns detailed criterion evaluations (booleans or text)
        - ``"binary"`` : returns boolean compliance results

    Returns
    -------
    pandas.DataFrame
        A DataFrame containing classification results for each weld (rows) and each 
        reference metal (columns).  
        The content depends on the chosen `format`:
        - **score** → float values in [0, 1]  
        - **detail** → outputs from `check_conditions` 
        - **binary** → boolean values (`True` if the weld meets all criteria)

    Raises
    ------
    Exception
        If `format` is not one of ("score", "detail", "binary").
    """

    couple_metal = create_criteres(bdd_metal)
    results = pd.DataFrame(index=bdd_weld.index)

    if format == "score":
        for couple in couple_metal.keys():
            score_yield = np.minimum(bdd_weld["Yield strength"] / couple_metal[couple]["Min Yield strength"], 1)
            score_uts = np.minimum(bdd_weld["Ultimate tensile strength"] / couple_metal[couple]["Min Ultimate tensile strength"], 1)
            score_elong = np.minimum(bdd_weld["Elongation"] / couple_metal[couple]["Min Elongation"], 1)
            score_area = np.minimum(couple_metal[couple]["Max Reduction of area"] / bdd_weld["Reduction of area"], 1)
            
            results[couple] = (score_yield + score_uts + score_elong + score_area) / 4


    elif format == "detail":
         
        for couple in couple_metal.keys():
            results[couple] = bdd_weld.apply(check_conditions, axis=1,couple_metal=couple_metal , couple=couple)
    
    elif format == "binary":

        for couple in couple_metal.keys():

            yield_strength = bdd_weld["Yield strength"] >= couple_metal[couple]["Min Yield strength"]
            tensile_strength = bdd_weld["Ultimate tensile strength"] >= couple_metal[couple]["Min Ultimate tensile strength"]
            elongation = bdd_weld["Elongation"] >= couple_metal[couple]["Min Elongation"]
            reduction_area = bdd_weld["Reduction of area"] <= couple_metal[couple]["Max Reduction of area"]
            
            results[couple] = yield_strength & tensile_strength & elongation & reduction_area
    
    else:
        raise Exception("Unsupported format. Please enter a valid format among (score, detail, binary)")
    
    return results

def plot_result(predicted_indices:dict, df_classif_bin:pd.DataFrame, df_classif_score:pd.DataFrame) -> None:
    """
    Visualizes and summarizes the weld classification results after prediction.

    Parameters
    ----------
    predicted_indices : dict
        Dictionary containing indices of the welds whose target values were predicted.
        Each key corresponds to a category or model, and each value is a list (or array-like)
        of DataFrame indices referring to the predicted weld samples.

    df_classif_bin : pandas.DataFrame
        Binary classification results for welds.  
        Columns correspond to metals (or metal types), and values are boolean (`True` if 
        the weld meets all property criteria, `False` otherwise).  
        The index should represent unique weld identifiers.

    df_classif_score : pandas.DataFrame
        Score-based classification results for welds.  
        Columns correspond to metals, and values represent normalized scores between 0 and 1
        (typically the output of `classif_weld(..., format="score")`).

    Returns
    -------
    None
        This function does not return a value.  
        It prints summary information and displays matplotlib/seaborn histograms for each
        reference metal in `df_classif_score`.

    Notes
    -----
    - The function separates welds into two groups:
        * **Predicted welds**: those with indices listed in `predicted_indices`
        * **Known welds**: those not predicted (original dataset)
    - For each metal (column in `df_classif_score`), it prints:
        * Total number of acceptable welds
        * Number of acceptable welds among known (original) samples
        * Number of acceptable welds among predicted samples
    - Then it plots the score distribution for each metal, highlighting known data.
    """
    idxs = []

    for idx in predicted_indices.values():
        idxs += idx

    mask_pred = df_classif_bin.index.isin(idxs)
    mask_ds = ~df_classif_bin.index.isin(idxs)

    for col in df_classif_score.columns:
        count = (df_classif_bin[col]).sum()
        count_pred = (df_classif_bin[col][mask_pred]).sum()
        count_ds = (df_classif_bin[col][mask_ds]).sum()
        print(col)
        print(f"Acceptable welds for {col} : {count}")
        print(f"Number of acceptable weld from the original/filled dataset : {count_ds}")
        print(f"Number of acceptable weld which has at least one predicted target : {count_pred}")
        plt.figure(figsize=(10, 4))
        bins = np.linspace(df_classif_score[col].min(), df_classif_score[col].max(), 70)
        sns.histplot(df_classif_score[col], bins=70, label="Score distribution")
        sns.histplot(df_classif_score[col][mask_ds], bins=70, label="Score distribution for known data", alpha=0.5)
        plt.title(f"Score distribution for {col}")
        plt.xlabel("Score")
        plt.legend()
        plt.tight_layout()
        plt.show()

def count_fail_cause(weld_list:list[str], df_classif_detail:pd.DataFrame) -> None:
    """
    Count the number of unacceptable welds for each failure category.

    Parameters
    ----------
    weld_list : list of str
        List of weld identifiers (column names) to evaluate.
    df_classif_detail : pandas.DataFrame
        DataFrame containing classification details with failure reasons
        in columns corresponding to each weld.

    Returns
    -------
    None
        Prints the number of failed welds per defect category for each weld.
    """
    for weld in weld_list:
        print(weld)
        YS = 0
        UTS = 0
        E = 0
        RoA = 0
        vl = df_classif_detail[weld].value_counts()
        for i in vl.index:
            if 'Yield strength' in i:
                YS += vl[i]
            if 'Ultimate tensile strength' in i:
                UTS += vl[i]
            if 'Elongation' in i:
                E += vl[i]
            if 'Reduction of area' in i:
                RoA += vl[i]
        print(f"Number of unnacceptable weld due to Yield Strength : {YS}")
        print(f"Number of unnacceptable weld due to Ultimate Tensile Strength : {UTS}")
        print(f"Number of unnacceptable weld due to Elongation : {E}")
        print(f"Number of unnacceptable weld due to Reduction of Area : {RoA}")
        print("--------------------------------------------------------------------")